---
pagetitle: "COVID-19 cases in Trafford"
output: html_document
runtime: shiny
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse) ; library(httr) ; library(readxl) ;   library(lubridate) ; library(RcppRoll) ; library(reactable) ; library(zoo) ; library(ggtext) ; library(scales) ; library(shiny) ; library(ggrepel) ; library(sf) ; library(leaflet) ; library(htmlwidgets) ; library(htmltools)

# Mid-2019 population estimates
population <- read_csv("data/population.csv")

# Confirmed cases
# Source: Public Health England
# URL: https://coronavirus.data.gov.uk
raw <- read_csv("https://coronavirus.data.gov.uk/downloads/csv/coronavirus-cases_latest.csv")

cases <- raw %>% 
  filter(`Area type` %in% c("nation", "ltla"),
         `Area name` %in% c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale", "Salford", "Stockport", "Tameside", "Trafford", "Wigan", "England")) %>% 
  mutate(date = as.Date(`Specimen date`, format = "%Y-%m-%d")) %>% 
  select(date,
         area_code = `Area code`,
         area_name = `Area name`,
         new_cases = `Daily lab-confirmed cases`) %>% 
  arrange(date) %>% 
  group_by(area_code, area_name) %>%
  complete(date = seq.Date(min(date), max(date), by = "day")) %>% 
  mutate(new_cases = replace_na(new_cases, 0)) %>% 
  ungroup() %>% 
  fill(area_name) %>%
  bind_rows(
    filter(., area_name != "England") %>% 
    group_by(., date) %>%
      summarise(area_code = "E11000001",
                area_name = "Greater Manchester",
                date = unique(date),
                new_cases = sum(new_cases))
    )

# ------------------------------------------------------------------------------

# Trafford local authority boundary
# Source: ONS Open Geography Portal
# URL: https://geoportal.statistics.gov.uk

la <- st_read("data/la.geojson")

# MSOAs within Trafford
# Source: ONS Open Geography Portal
# URL: https://geoportal.statistics.gov.uk

msoa <- st_read("data/msoa.geojson")

# Weekly confirmed cases by MSOA
# Source: Public Health England
# URL: https://coronavirus.data.gov.uk/

# Using latest 7 days of complete cases

msoa_cases <- read_csv("https://coronavirus.data.gov.uk/downloads/msoa_data/MSOAs_latest.csv") %>% 
  filter(msoa11_cd %in% msoa$msoa11cd) %>% 
  select(lad19nm = lad19_nm,
         msoa11cd = msoa11_cd,
         msoa11hclnm = msoa11_hclnm,
         n = tail(names(.), 1)) %>% 
  mutate(n = ifelse(n == -99, 0, n),
         n = as.integer(n)) %>% 
  relocate(n, .after = last_col())
```

```{css}
@import url('https://fonts.googleapis.com/css2?family=Lato&display=swap');

.div {
  font-family: 'Lato', sans-serif;
}

.title {
  font-size: 18px;
  font-weight: bold;
}

.subtitle {
  margin: 8px 0;
  font-size: 14px;
}

.caption {
  text-align: right;
  font-size: 12px;
  color: #212121;
}

.tbl {
  font-size: 14px;
  line-height: 18px;
}

.row_bold {
  font-weight: bold;
}
```

## Confirmed cases of coronavirus in Trafford

<br />
<div class="container-fluid">
<div class="row">
<div class = "col-sm-6">
<div class = "div">
```{r, dev = 'svg'}
rolling_cases <- cases %>% 
  filter(area_name == "Trafford", date <= max(date)-days(2)) %>% 
  mutate(ma_cases = rollmean(new_cases, 7, align = "center", fill = NA)) 

    div(class = "subtitle",
        div(class = "title", "Daily confirmed cases"),
        paste("Trafford, to", format(max(rolling_cases$date), '%d %B %Y')))

ggplot() +
  geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
  geom_col(data = rolling_cases, aes(x = date, y = new_cases), fill = "#39809E", alpha = 0.6) +
  geom_line(data = rolling_cases, aes(x = date, y = ma_cases, colour = "ma_cases"), size = 1) +
  scale_colour_manual(values = c("ma_cases" = "#39809E"), name = NULL, labels = "7-day rolling average") +
  scale_x_date(date_labels = "%b") +
  scale_y_continuous(expand = c(0.005, 0.005), position = "right") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
  theme_minimal(base_size = 20, base_family = "Lato") +
  theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top", 
        legend.justification = "left",
        legend.direction = "horizontal",
        legend.text = element_text(size = 12),
        axis.text.y = element_text(face = "bold")) 

    div(class = "caption", p("Source: ", a("Public Health England", href = 'https://coronavirus.data.gov.uk/', target = "_blank")))
```
</div>
</div>
  
<div class = "col-sm-6">
<div class = "div">
```{r, dev = 'svg'}
total_cases <- cases %>% 
  filter(area_name == "Trafford", date <= max(date)-days(2)) %>% 
  arrange(date) %>% 
  mutate(cum_cases = cumsum(new_cases))

    div(class = "subtitle",
        div(class = "title", "Cumulative cases"),
        paste("Trafford, to", format(max(total_cases$date), '%d %B %Y')))

ggplot(data = total_cases, aes(x = date, y = cum_cases, group = 1)) +
  geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
  geom_line(colour = "#39809E", size = 1.2) +
  scale_x_date(date_labels = "%b") +
  scale_y_continuous(expand = c(0.005, 0.005), labels = comma, position = "right") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
  theme_minimal(base_size = 20, base_family = "Lato") +
  theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(face = "bold"))

    div(class = "caption", p("Source: ", a("Public Health England", href = 'https://coronavirus.data.gov.uk/', target = "_blank")))
```
</div>
</div>
</div>

<div class = "row">
<div class = "col-sm-12">
<div class = "div">
```{r}
# weekly case count by MSOA
local_cases <- left_join(msoa, msoa_cases, by = "msoa11cd") %>% 
  mutate(popup = ifelse(n == 0,
                        str_c("<strong>", msoa11hclnm, "</strong><br/><em>", lad19nm, "</em><br/>Data suppressed") %>% map(HTML),
                        str_c("<strong>", msoa11hclnm, "</strong><br/><strong>", n, "</strong> cases") %>% map(HTML)))

div(class = "subtitle",
    div(class = "title", "Confirmed cases by MSOA"),
    "Trafford, latest 7 days where near-complete data are available")

# create map
bbox <- as.vector(st_bbox(local_cases))

leaflet(data = local_cases, width = "100%", options = leafletOptions(zoomControl = FALSE)) %>%
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>%
  addTiles(urlTemplate = "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png", attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a> | <a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data Â© Crown copyright and database right (2020)</a>', options = tileOptions(minZoom = 11, maxZoom = 11)) %>%
  addPolygons(data = la, fillColor = "transparent", stroke = TRUE, weight = 1, color = "#bdbdbd", opacity = 1) %>% 
  addCircleMarkers(lng = ~lon, lat = ~lat, radius = ~sqrt(n), fillColor = "#39809E", fillOpacity = 1, weight = 1, color = "#FFFFFF", opacity = 1) %>%
  addPolygons(fillColor = "transparent", stroke = TRUE, weight = 1, color = "transparent", opacity = 1, label = ~popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "bottom", offset = c(0, 20)), highlight = highlightOptions(fillColor = "transparent", stroke = TRUE, color = "#39809E", weight = 2, bringToFront = TRUE)) %>%
  onRender("function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}", paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))

div(class = "caption", p("Source: ", a("Public Health England", href = 'https://coronavirus-staging.data.gov.uk/cases', target = "_blank")))
```
</div>
</div>
</div>

<div class = "row">
<div class = "col-sm-12">
<div class = "div">
```{r table}
# weekly incidence rate
weekly_incidence <- cases %>% 
  mutate(period = case_when(
    date >= max(date)-days(8) & date <= max(date)-days(2) ~ "current_week",
    date >= max(date)-days(15) & date <= max(date)-days(9) ~ "previous_week"
  )) %>% 
  filter(!is.na(period)) %>% 
  select(-date) %>%
  group_by(area_code, area_name, period) %>% 
  summarise(total_cases = sum(new_cases)) %>% 
  pivot_wider(names_from = period, values_from = total_cases) %>% 
  select(area_code, area_name, previous_week, current_week) %>%
  left_join(population, by = "area_code") %>% 
  mutate(previous_week_rate = round(previous_week/population*100000,1),
         current_week_rate = round(current_week/population*100000,1),
         change = current_week-previous_week,
         change_rate = round(change/population*100000,1)) %>% 
  ungroup() %>%
  select(area_name, previous_week_rate, current_week_rate, change_rate)

tbl <- reactable(weekly_incidence, 
          defaultPageSize = 12,
          highlight = TRUE, 
          height = "auto",
          compact = TRUE,
          borderless = FALSE,
          wrap = FALSE,
          resizable = TRUE,
          defaultSorted = "current_week_rate",
          defaultSortOrder = "desc",
          defaultColDef = colDef(align = "left"),
          rowClass = function(index) {if (weekly_incidence[index, "area_name"] %in% c("Trafford", "Greater Manchester", "England")) {"row_bold"}},
          columns = list(
            area_name = colDef(name = "", sortable = FALSE, align = "left"),
            previous_week_rate = colDef(header = paste(format(max(cases$date)-days(15),'%d %b'),"-", format(max(cases$date)-days(9),'%d %b')),
                                        align = "left"),
            current_week_rate = colDef(header = paste(format(max(cases$date)-days(8),'%d %b'),"-", format(max(cases$date)-days(2),'%d %b')), 
                                       align = "left"),
            change_rate = colDef(name = "Change", align = "left"))
)

div(class = "div",
    div(class = "subtitle",
        div(class = "title", "Weekly incidence per 100,000 population"),
        paste("Greater Manchester, ", format(max(cases$date)-days(15), "%d %B"), "to", format(max(cases$date)-days(2), "%d %B %Y"))
        ),
    tbl,
    div(class = "caption", p("Source: ", a("Public Health England", href = 'https://coronavirus.data.gov.uk/', target = "_blank")))
    )
```
</div>
</div>
</div>

<div class = "row">
<div class = "col-sm-12">
<div class = "div">
```{r,  fig.width = 12, dev = 'svg'}
# prevalence and growth
weekly_cases <- raw %>% 
  filter(`Area type` == "ltla") %>% 
  mutate(date = as.Date(`Specimen date`, format = "%Y-%m-%d")) %>% 
  select(date,
         area_code = `Area code`,
         area_name = `Area name`,
         new_cases = `Daily lab-confirmed cases`) %>% 
  arrange(date) %>% 
  group_by(area_code, area_name) %>%
  complete(date = seq.Date(min(date), max(date), by = "day")) %>% 
  mutate(new_cases = replace_na(new_cases, 0)) %>% 
  ungroup() %>% 
  fill(area_name) %>%
  left_join(population, by = "area_code") %>% 
  mutate(rate = round(new_cases/population*100000,1)) %>%  
  group_by(area_name) %>% 
  mutate(previous_week = roll_sum(lag(rate, 7), 7, fill = NA, align = "right"),
         current_week = roll_sum(rate, 7, fill = NA, align = "right"),
         change = current_week/previous_week) %>% 
  ungroup() %>% 
  # include latest 'complete' cases
  filter(date == max(date)-days(2))

div(class = "subtitle",
    div(class = "title", "Local prevalence and growth rate in cases"),
    paste("Local authorities in England, as of", format(max(weekly_cases$date), '%d %B %Y')))

ggplot() +
  geom_hline(yintercept = 1, size = 1, colour = "#333333") +
  geom_point(data = filter(weekly_cases, !area_name %in% c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale", "Trafford", "Salford", "Stockport", "Tameside", "Wigan")), aes(x = rate, y = change, size = population), shape = 21, fill = "#bdbdbd", colour = "#757575", alpha = 0.5) +
  geom_point(data = filter(weekly_cases, area_name == "Trafford"), 
             aes(rate, y = change, size = population), shape = 21, fill = "#00AFBB", colour = "#000000") +
  geom_text_repel(data = filter(weekly_cases, area_name == "Trafford"), 
                  aes(rate, y = change, label = area_name), size = 4, point.padding = 0.5) +
  # other GM local authorities
  geom_point(data = filter(weekly_cases, area_name %in% c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale",  "Salford", "Stockport", "Tameside", "Wigan")), 
             aes(rate, y = change, size = population), shape = 21, fill = "#E7B800", colour = "#000000") +
  geom_text_repel(data = filter(weekly_cases, area_name %in% c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale",  "Salford", "Stockport", "Tameside", "Wigan")),
                  aes(rate, y = change, label = area_name), size = 4, point.padding = 0.5) +
  annotate("text", x = max(weekly_cases$rate)*0.1, y = 5, label = "Low and rising", size = 7, hjust = 0, colour = "#757575") +
  annotate("text", x = max(weekly_cases$rate)*0.1, y = 0.4, label = "Low and falling", size = 7, hjust = 0, colour = "#757575") +
  annotate("text", x = max(weekly_cases$rate)*0.6, y = 5, label = "High and rising", size = 7, hjust = 0, colour = "#757575") +
  annotate("text", x = max(weekly_cases$rate)*0.6, y = 0.4, label = "High and falling", size = 7, hjust = 0, colour = "#757575") +
  scale_x_continuous(expand = c(0.005, 0.005),
                     breaks = seq(0, max(weekly_cases$rate), 10),
                     labels = seq(0, max(weekly_cases$rate), 10),
                     limits = c(0, max(weekly_cases$rate))) +
  scale_y_log10(expand = c(0.005, 0.005),
                breaks = c(0.25, 0.5, 1, 2, 4, 8),
                labels = paste(c(0.25, 0.5, 1, 2, 4, 8), "x"),
                limits = c(0.2, 10),
                position = "right") +
  labs(x = "New cases per 100k people", y = "Week-on-week\nchange in cases",
       title = NULL, subtitle = NULL, caption = NULL) +
  theme_minimal(base_size = 20, base_family = "Lato") +
  theme(panel.grid.major = element_line(colour = "#bdbdbd"),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 12, hjust = 0, margin = margin(t = 10)),
        axis.title.y.right = element_text(size = 12, angle = 0, vjust = 1, margin = margin(l = -2)),
        legend.position = "none",
        axis.text = element_text(face = "bold")) +
  coord_cartesian(clip = "off")

div(class = "caption", p("Source: ", a("Public Health England", href = 'https://coronavirus.data.gov.uk/', target = "_blank"), "| Credits: ", a("@jburnmurdoch", href = 'https://twitter.com/jburnmurdoch/status/1288500620496908288', target = "_blank")))
```
</div>
</div>
</div>
</div>